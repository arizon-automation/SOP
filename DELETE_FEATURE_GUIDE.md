# 🗑️ 删除功能使用指南
## Delete Documents and SOPs Guide

**更新时间**: 2025-11-04  
**新功能**: 完整的删除文档和SOP功能

---

## ✨ 新增功能

现在你可以在3个地方删除内容：

### 1. 📄 文档列表页 (`/documents`)
- 每个文档卡片右上角有删除按钮（🗑️图标）
- 点击后会弹出确认对话框
- **重要提示**: 删除文档会同时删除所有关联的SOP

### 2. 📄 文档详情页 (`/documents/[id]`)
- 右侧操作区域有"删除文档"按钮
- 点击后会弹出确认对话框
- **重要提示**: 删除文档会同时删除所有关联的SOP

### 3. 📋 SOP列表页 (`/sops`)
- 每个SOP卡片右上角有删除按钮（🗑️图标）
- 点击后会弹出确认对话框
- 只删除当前SOP，不影响原文档
- 如果有翻译对（中英文版本），翻译对不会被删除，但关联会被清除

### 4. 📋 SOP详情页 (`/sops/[id]`)
- 右侧操作区域有"删除SOP"按钮
- 点击后会弹出确认对话框
- 只删除当前SOP，不影响原文档

---

## 🎯 删除行为说明

### 删除文档 (Document)

```
删除文档 → 自动删除所有关联的SOP
```

**影响范围**:
- ✅ 文档本身被删除
- ✅ 该文档生成的所有SOP（中文和英文）都被删除
- ✅ SOP的内容块、问答记录等相关数据也被删除（数据库级联）

**确认对话框**:
```
确定要删除文档 "XXX" 吗？

注意：删除文档会同时删除所有关联的SOP！

此操作无法撤销。
```

### 删除SOP

```
删除SOP → 只删除该SOP，原文档保留
```

**影响范围**:
- ✅ 该SOP被删除
- ✅ 关联的翻译版本的`translation_pair_id`被清除（但翻译版本本身不会被删除）
- ❌ 原始文档不受影响

**确认对话框**:
```
确定要删除这个SOP吗？此操作无法撤销。

注意：如果有对应的翻译版本，翻译版本不会被删除，但关联会被清除。
```

---

## 🔧 技术实现

### 后端API

#### 1. 删除文档 API
**路径**: `DELETE /api/documents/[id]`

**逻辑**:
```typescript
1. 检查文档是否存在
2. 先删除所有关联的SOP (DELETE FROM sops WHERE document_id = ?)
3. 再删除文档本身 (DELETE FROM sop_documents WHERE id = ?)
4. 返回成功消息
```

**为什么要手动删除SOP？**
- 数据库中`sops.document_id`的外键设置是`ON DELETE SET NULL`
- 这意味着删除文档时，SOP的`document_id`会被设为NULL，但SOP本身不会被删除
- 我们需要手动删除SOP以保持数据一致性

#### 2. 删除SOP API
**路径**: `DELETE /api/sops/[id]`

**逻辑**:
```typescript
1. 检查SOP是否存在
2. 获取翻译对ID (translation_pair_id)
3. 删除当前SOP (DELETE FROM sops WHERE id = ?)
4. 如果有翻译对，清除翻译对的关联 (UPDATE sops SET translation_pair_id = NULL)
5. 返回成功消息
```

### 前端UI

#### 列表页删除按钮
```tsx
<button
  onClick={(e) => handleDelete(id, title, e)}
  disabled={deletingId === id}
  className="absolute top-4 right-4 p-2 text-red-500 hover:bg-red-50..."
>
  {deletingId === id ? <Spinner /> : <TrashIcon />}
</button>
```

**特点**:
- 绝对定位在右上角
- 点击时阻止Link跳转 (`e.preventDefault()`)
- 删除中显示加载动画
- 删除成功后自动刷新列表

#### 详情页删除按钮
```tsx
<button
  onClick={handleDelete}
  disabled={deleting}
  className="w-full px-4 py-3 bg-red-50 hover:bg-red-100..."
>
  {deleting ? '删除中...' : '删除文档/SOP'}
</button>
```

**特点**:
- 全宽按钮
- 删除成功后自动跳转到列表页
- 删除失败显示错误提示

---

## 🛡️ 安全性

### 权限检查
- ✅ 所有删除操作都需要登录（`requireAuth()`）
- ✅ 目前任何登录用户都可以删除（未来可以基于角色限制）

### 确认对话框
- ✅ 删除前必须确认
- ✅ 明确提示删除影响范围
- ✅ 提醒操作不可撤销

### 错误处理
- ✅ 文档/SOP不存在 → 返回404
- ✅ 数据库错误 → 返回500并显示错误消息
- ✅ 未登录 → 返回401并跳转到登录页

---

## 📝 使用示例

### 场景1: 删除测试文档

1. 进入 `/documents` 页面
2. 找到你想删除的文档
3. 点击右上角的🗑️图标
4. 确认删除
5. 文档和所有关联SOP被删除
6. 列表自动刷新

### 场景2: 只删除某个SOP

1. 进入 `/sops` 页面
2. 找到你想删除的SOP
3. 点击右上角的🗑️图标
4. 确认删除
5. 只有该SOP被删除，文档保留
6. 如果有中英文两个版本，你需要分别删除

### 场景3: 从详情页删除

1. 打开文档或SOP的详情页
2. 在右侧操作区域找到"删除"按钮
3. 点击并确认
4. 删除成功后自动跳转到列表页

---

## ⚠️ 注意事项

### 1. 删除是永久性的
- ❌ 没有回收站功能
- ❌ 无法撤销删除
- ✅ 删除前请仔细确认

### 2. 删除文档的影响
- 删除文档 = 删除所有关联SOP
- 如果文档生成了中文和英文SOP，两个都会被删除
- 文件本身（PDF/Word）也会从存储中删除（如果使用Vercel Blob）

### 3. 删除SOP的影响
- 删除SOP不影响原文档
- 可以重新点击"AI解析"重新生成SOP
- 如果SOP有翻译对，删除一个不会删除另一个

### 4. 级联删除
数据库中的级联删除关系：
```
sop_documents
  ↓ (手动删除)
sops
  ↓ (ON DELETE CASCADE)
sop_content_blocks
  ↓ (ON DELETE CASCADE)
...其他相关表
```

---

## 🔮 未来改进

### 计划中的功能：

1. **软删除 (Soft Delete)**
   - 添加`deleted_at`字段
   - 删除的内容可以在回收站中恢复
   - 30天后自动永久删除

2. **批量删除**
   - 选择多个文档/SOP一次性删除
   - 批量操作确认

3. **删除权限控制**
   - 只有管理员可以删除
   - 或者只能删除自己上传的文档

4. **删除日志**
   - 记录谁在什么时候删除了什么
   - 用于审计和追踪

5. **关联提示**
   - 删除文档前显示会影响多少个SOP
   - 显示SOP的标题列表

---

## 🎨 UI 设计

### 删除按钮样式

#### 列表页（小按钮）
- 位置：右上角
- 颜色：红色（`text-red-500`）
- 悬停：浅红色背景（`hover:bg-red-50`）
- 图标：垃圾桶（TrashIcon）

#### 详情页（大按钮）
- 位置：操作区域底部
- 颜色：浅红色背景，红色文字
- 悬停：更深的红色背景
- 图标：垃圾桶 + 文字

### 删除中状态
- 按钮变为禁用状态
- 显示旋转的加载动画
- 文字变为"删除中..."

### 确认对话框
- 使用浏览器原生`confirm()`
- 简洁明确的提示文字
- 未来可以升级为自定义Modal

---

## 🐛 故障排除

### 问题1: 删除按钮点击无反应
**原因**: 可能未登录或会话过期
**解决**: 刷新页面重新登录

### 问题2: 删除失败提示"文档不存在"
**原因**: 文档可能已被其他人删除
**解决**: 刷新页面查看最新列表

### 问题3: 删除文档后SOP还在
**原因**: 数据库级联删除未正确配置
**解决**: 检查API代码，确保手动删除SOP

### 问题4: 删除后列表没刷新
**原因**: 前端刷新逻辑问题
**解决**: 
- 列表页：检查`loadDocuments()`/`loadSOPs()`是否被调用
- 详情页：检查是否正确跳转到列表页

---

## 📊 数据库表关系

```sql
-- 文档表
sop_documents (id, title, ...)
  ↓
  | document_id (ON DELETE SET NULL - 需要手动处理)
  ↓
-- SOP表  
sops (id, title, document_id, ...)
  ↓
  | sop_id (ON DELETE CASCADE - 自动删除)
  ↓
-- SOP内容块表
sop_content_blocks (id, sop_id, content, ...)

-- SOP问答历史
sop_qa_history (id, matched_sop_ids[], ...)

-- SOP审批记录
sop_approvals (id, sop_id, ...) (ON DELETE CASCADE)

-- 分析统计
sop_analytics (id, sop_id, ...) (ON DELETE CASCADE)
```

---

## ✅ 功能清单

- [x] 文档列表页删除按钮
- [x] 文档详情页删除按钮
- [x] SOP列表页删除按钮
- [x] SOP详情页删除按钮
- [x] 删除文档API
- [x] 删除SOP API
- [x] 确认对话框
- [x] 加载状态显示
- [x] 错误处理
- [x] 列表自动刷新
- [x] 级联删除SOP
- [x] 翻译对关联清除
- [ ] 软删除（计划中）
- [ ] 批量删除（计划中）
- [ ] 权限控制（计划中）
- [ ] 删除日志（计划中）

---

## 🎉 总结

现在你可以轻松地删除不需要的文档和SOP了！

**关键点**:
1. **删除文档 = 删除所有关联SOP**（慎重操作）
2. **删除SOP = 只删除SOP，保留文档**（相对安全）
3. 所有删除操作都有确认对话框
4. 删除后自动刷新或跳转

**建议**:
- 删除前仔细确认
- 如果不确定，可以先查看详情页
- 重要文档建议先备份

所有更改已推送到GitHub！🚀

