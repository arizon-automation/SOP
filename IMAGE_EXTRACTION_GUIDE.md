# 📸 图片提取功能说明
## Document Image Preservation System

---

## ✨ 功能概述

现在AI解析系统会**自动提取并保存**文档中的所有图片！

### 支持的功能：

- ✅ **从Word文档提取图片** (.docx)
- ✅ **自动上传到云存储** (Vercel Blob或本地)
- ✅ **保存图片引用** 到SOP内容
- ✅ **在SOP详情页显示** 图片画廊
- ✅ **点击放大查看** 完整图片
- ⚠️ **PDF图片提取** (暂不支持，建议使用Word格式)

---

## 🎯 工作流程

```
1. 上传包含图片的Word文档
   ↓
2. 点击"AI解析"按钮
   ↓
3. 系统自动执行：
   ├─ 📸 提取所有图片
   ├─ 💾 上传到存储（本地/云端）
   ├─ 📄 提取文本内容
   ├─ 🤖 AI分析流程
   ├─ 🌏 翻译成双语
   └─ 💿 保存到数据库（含图片链接）
   ↓
4. 在SOP详情页查看：
   ├─ 📷 顶部显示图片画廊
   ├─ 📋 下方显示流程步骤
   └─ 🖱️ 点击图片放大查看
```

---

## 💡 使用建议

### ✅ 最佳实践：

1. **使用Word格式** (.docx)
   - 图片提取更可靠
   - 支持所有常见图片格式
   - 推荐用于包含图片的文档

2. **图片清晰度**
   - 使用高质量图片（建议至少800px宽）
   - 确保图片清晰可见
   - 避免过度压缩

3. **图片数量**
   - 理论上无限制
   - 建议每个SOP不超过10-15张
   - 保持文件大小在10MB以内

### ⚠️ PDF限制：

目前**PDF图片提取暂不支持**，因为：
- pdf-parse库只提取文本，不提取图片
- 需要额外的库（pdf.js或pdf-lib）
- 可能增加复杂度和成本

**解决方案**：
- 将PDF转换为Word格式
- 或者使用原始Word文档
- 未来版本可能添加PDF图片支持

---

## 🎨 显示效果

### SOP详情页布局：

```
┌─────────────────────────────────────┐
│  指导图片 (3 张)                     │
│  ┌────────┐ ┌────────┐ ┌────────┐  │
│  │ 图片 1 │ │ 图片 2 │ │ 图片 3 │  │
│  │        │ │        │ │        │  │
│  └────────┘ └────────┘ └────────┘  │
│  点击查看大图                       │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  流程说明                           │
│  详细的流程描述...                  │
│  📷 本流程包含 3 张指导图片         │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  操作步骤                           │
│  1️⃣ 第一步...                       │
│  2️⃣ 第二步...                       │
│  3️⃣ 第三步...                       │
└─────────────────────────────────────┘
```

---

## 📊 技术实现

### 新增模块：

**1. 图片提取器** (`lib/sop/image-extractor.ts`)
```typescript
- extractImagesFromWord() // Word图片提取
- extractImagesFromPDF()  // PDF图片提取（预留）
- extractImages()         // 自动选择
```

**2. 图片存储**
- 本地开发：保存到 `uploads/` 文件夹
- Vercel部署：自动上传到 Vercel Blob
- 每张图片生成唯一文件名

**3. 数据库存储**
```json
{
  "title": "流程标题",
  "steps": [...],
  "images": [
    {
      "filename": "1730736000-a1b2c3-image.png",
      "url": "/uploads/1730736000-a1b2c3-image.png",
      "contentType": "image/png"
    }
  ]
}
```

**4. UI显示**
- 2列网格布局
- 悬停效果
- 点击放大
- 响应式设计

---

## 🧪 测试步骤

### Step 1: 准备测试文档

创建一个Word文档（.docx）包含：
- 文字说明的操作流程
- 3-5张指导图片
- 图片要清晰可见

### Step 2: 上传并解析

1. 上传Word文档
2. 点击"AI解析"按钮
3. 观察控制台输出：
   ```
   🖼️ Step 1: 提取文档图片...
   ✅ 图片已提取: 1730736000-a1b2c3-image.png
   ✅ 图片已提取: 1730736001-b2c3d4-image.png
   ✅ Word文档图片提取完成: 2 张
   ```

### Step 3: 查看结果

1. 自动跳转到SOP详情页
2. 顶部应该看到"指导图片 (X 张)"
3. 图片以网格形式显示
4. 点击图片可以在新标签页打开

### Step 4: 验证存储

**本地环境：**
```powershell
ls uploads/
# 应该看到提取的图片文件
```

**Vercel环境：**
- 图片自动上传到Vercel Blob
- URL格式：`https://xxx.vercel-storage.com/...`

---

## 💰 成本影响

### 存储成本：

**本地开发：**
- ✅ 免费（保存在本地硬盘）

**Vercel Blob：**
- 免费tier：1GB存储
- 假设每张图片平均200KB
- 可以存储 ~5000 张图片
- 对于MVP阶段完全够用

### API成本：

- 图片提取不调用OpenAI API
- **不增加AI成本** ✅
- 只是文件处理和上传

---

## 🔮 未来增强

### Phase 2.1 可能添加的功能：

1. **PDF图片提取**
   - 使用pdf.js或pdf-lib
   - 提取嵌入的图片
   - 估计开发时间：4-6小时

2. **图片OCR**
   - 识别图片中的文字
   - 添加到SOP描述中
   - 需要额外的OCR服务

3. **图片标注**
   - 在图片上添加注释
   - 箭头、文字说明
   - 增强指导效果

4. **图片压缩**
   - 自动压缩大图片
   - 减少存储空间
   - 提高加载速度

5. **图片排序**
   - 手动调整图片顺序
   - 与步骤关联
   - 更灵活的展示

---

## 📝 常见问题

### Q: PDF文档中的图片会丢失吗？

**A**: 是的，目前PDF图片提取暂不支持。

**解决方案**：
1. 将PDF转换为Word格式（推荐）
2. 使用原始Word文档
3. 等待未来版本支持

### Q: 图片大小有限制吗？

**A**: 
- 单个图片：建议 < 2MB
- 总文档：< 10MB（包含所有图片）

### Q: 支持什么图片格式？

**A**: Word文档中常见的格式都支持：
- ✅ PNG
- ✅ JPEG/JPG
- ✅ GIF
- ✅ BMP
- ✅ SVG

### Q: 图片会被压缩吗？

**A**: 
- 本地开发：原样保存
- Vercel Blob：原样保存
- 未来可能添加自动压缩功能

### Q: 图片顺序会保留吗？

**A**: 是的，按照文档中出现的顺序保存和显示。

---

## ✅ 更新总结

### 新增文件：

```
✅ lib/sop/image-extractor.ts       - 图片提取工具
✅ IMAGE_EXTRACTION_GUIDE.md        - 本文档
```

### 修改文件：

```
✅ lib/sop/document-parser.ts       - 添加图片占位符
✅ lib/sop/sop-generator.ts         - 集成图片提取
✅ app/sops/[id]/page.tsx           - 显示图片画廊
```

### 数据库变化：

```
✅ sops.content (JSONB)             - 包含 images 数组
```

---

## 🎉 使用效果

### Before (没有图片):
```
📋 操作步骤
1. 第一步...
2. 第二步...
❌ 图片丢失！
```

### After (保留图片):
```
📷 指导图片 (3 张)
[图片1] [图片2] [图片3]

📋 操作步骤
1. 第一步...
2. 第二步...
✅ 图片完整保留！
```

---

**现在文档中的指导图片不会再丢失了！** 🎉

**建议**：使用Word格式上传包含图片的SOP文档，可以获得最佳效果！

